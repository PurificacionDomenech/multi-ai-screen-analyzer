// ============================================
// DEEPSEEK AI
// ============================================
async function analyzeWithDeepSeek(imageBase64) {
  const key = localStorage.getItem('deepseek_api_key');
  
  if (!key) {
    return { ai: 'DeepSeek', icon: 'üîÆ', content: 'Error: API key no configurada', success: false };
  }
  
  try {
    const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${key}`
      },
      body: JSON.stringify({
        model: 'deepseek-vl',
        messages: [{
          role: 'user',
          content: [
            { type: 'text', text: 'Analiza esta pantalla en detalle. Si ves c√≥digo, identifica posibles errores, bugs o mejoras. Si es una UI, sugiere mejoras de dise√±o. Si es otra cosa, describe lo que ves y da recomendaciones √∫tiles.' },
            { type: 'image_url', image_url: { url: `data:image/png;base64,${imageBase64}` }}
          ]
        }],
        max_tokens: 1024
      })
    });
    
    if (!response.ok) throw new Error(`Error ${response.status}`);
    const data = await response.json();
    
    return { ai: 'DeepSeek', icon: 'üîÆ', content: data.choices[0].message.content, success: true };
  } catch (error) {
    return { ai: 'DeepSeek', icon: 'üîÆ', content: `Error: ${error.message}`, success: false };
  }
}

async function chatWithDeepSeek(message, imageBase64) {
  const key = localStorage.getItem('deepseek_api_key');
  
  try {
    const content = [];
    if (message) content.push({ type: 'text', text: message });
    if (imageBase64) content.push({ type: 'image_url', image_url: { url: `data:image/png;base64,${imageBase64}` }});

    const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${key}`
      },
      body: JSON.stringify({
        model: 'deepseek-vl',
        messages: [{ role: 'user', content }],
        max_tokens: 2048
      })
    });
    
    if (!response.ok) throw new Error(`Error ${response.status}`);
    const data = await response.json();
    
    return { ai: 'DeepSeek', icon: 'üîÆ', content: data.choices[0].message.content, success: true };
  } catch (error) {
    return { ai: 'DeepSeek', icon: 'üîÆ', content: error.message, success: false };
  }
}

// ============================================
// OPENAI GPT-4 VISION
// ============================================
async function analyzeWithOpenAI(imageBase64) {
  const key = localStorage.getItem('openai_api_key');
  
  if (!key) {
    return { ai: 'GPT-4 Vision', icon: 'ü§ñ', content: 'Error: API key no configurada', success: false };
  }
  
  try {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${key}`
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [{
          role: 'user',
          content: [
            { type: 'text', text: 'Analiza esta pantalla en detalle. Si ves c√≥digo, identifica posibles errores, bugs o mejoras. Si es una UI, sugiere mejoras de dise√±o. Si es otra cosa, describe lo que ves y da recomendaciones √∫tiles.' },
            { type: 'image_url', image_url: { url: `data:image/png;base64,${imageBase64}` }}
          ]
        }],
        max_tokens: 1024
      })
    });
    
    if (!response.ok) throw new Error(`Error ${response.status}`);
    const data = await response.json();
    
    return { ai: 'GPT-4 Vision', icon: 'ü§ñ', content: data.choices[0].message.content, success: true };
  } catch (error) {
    return { ai: 'GPT-4 Vision', icon: 'ü§ñ', content: `Error: ${error.message}`, success: false };
  }
}

async function chatWithOpenAI(message, imageBase64) {
  const key = localStorage.getItem('openai_api_key');
  
  try {
    const content = [];
    if (message) content.push({ type: 'text', text: message });
    if (imageBase64) content.push({ type: 'image_url', image_url: { url: `data:image/png;base64,${imageBase64}` }});

    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${key}`
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [{ role: 'user', content }],
        max_tokens: 2048
      })
    });
    
    if (!response.ok) throw new Error(`Error ${response.status}`);
    const data = await response.json();
    
    return { ai: 'GPT-4 Vision', icon: 'ü§ñ', content: data.choices[0].message.content, success: true };
  } catch (error) {
    return { ai: 'GPT-4 Vision', icon: 'ü§ñ', content: error.message, success: false };
  }
}

// ============================================
// MISTRAL PIXTRAL
// ============================================
async function analyzeWithMistral(imageBase64) {
  const key = localStorage.getItem('mistral_api_key');
  
  if (!key) {
    return { ai: 'Pixtral', icon: 'üåü', content: 'Error: API key no configurada', success: false };
  }
  
  try {
    const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${key}`
      },
      body: JSON.stringify({
        model: 'pixtral-12b-2409',
        messages: [{
          role: 'user',
          content: [
            { type: 'text', text: 'Analiza esta pantalla en detalle. Si ves c√≥digo, identifica posibles errores, bugs o mejoras. Si es una UI, sugiere mejoras de dise√±o. Si es otra cosa, describe lo que ves y da recomendaciones √∫tiles.' },
            { type: 'image_url', image_url: { url: `data:image/png;base64,${imageBase64}` }}
          ]
        }],
        max_tokens: 1024
      })
    });
    
    if (!response.ok) throw new Error(`Error ${response.status}`);
    const data = await response.json();
    
    return { ai: 'Pixtral', icon: 'üåü', content: data.choices[0].message.content, success: true };
  } catch (error) {
    return { ai: 'Pixtral', icon: 'üåü', content: `Error: ${error.message}`, success: false };
  }
}

async function chatWithMistral(message, imageBase64) {
  const key = localStorage.getItem('mistral_api_key');
  
  try {
    const content = [];
    if (message) content.push({ type: 'text', text: message });
    if (imageBase64) content.push({ type: 'image_url', image_url: { url: `data:image/png;base64,${imageBase64}` }});

    const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${key}`
      },
      body: JSON.stringify({
        model: 'pixtral-12b-2409',
        messages: [{ role: 'user', content }],
        max_tokens: 2048
      })
    });
    
    if (!response.ok) throw new Error(`Error ${response.status}`);
    const data = await response.json();
    
    return { ai: 'Pixtral', icon: 'üåü', content: data.choices[0].message.content, success: true };
  } catch (error) {
    return { ai: 'Pixtral', icon: 'üåü', content: error.message, success: false };
  }
}

// ============================================
// PERPLEXITY
// ============================================
async function analyzeWithPerplexity(imageBase64) {
  const key = localStorage.getItem('perplexity_api_key');
  
  if (!key) {
    return { ai: 'Perplexity', icon: 'üîç', content: 'Error: API key no configurada', success: false };
  }
  
  try {
    const response = await fetch('https://api.perplexity.ai/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${key}`
      },
      body: JSON.stringify({
        model: 'llama-3.2-90b-vision-instruct',
        messages: [{
          role: 'user',
          content: [
            { type: 'text', text: 'Analiza esta pantalla en detalle. Si ves c√≥digo, identifica posibles errores, bugs o mejoras. Si es una UI, sugiere mejoras de dise√±o. Si es otra cosa, describe lo que ves y da recomendaciones √∫tiles.' },
            { type: 'image_url', image_url: { url: `data:image/png;base64,${imageBase64}` }}
          ]
        }],
        max_tokens: 1024
      })
    });
    
    if (!response.ok) throw new Error(`Error ${response.status}`);
    const data = await response.json();
    
    return { ai: 'Perplexity', icon: 'üîç', content: data.choices[0].message.content, success: true };
  } catch (error) {
    return { ai: 'Perplexity', icon: 'üîç', content: `Error: ${error.message}`, success: false };
  }
}

async function chatWithPerplexity(message, imageBase64) {
  const key = localStorage.getItem('perplexity_api_key');
  
  try {
    const content = [];
    if (message) content.push({ type: 'text', text: message });
    if (imageBase64) content.push({ type: 'image_url', image_url: { url: `data:image/png;base64,${imageBase64}` }});

    const response = await fetch('https://api.perplexity.ai/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${key}`
      },
      body: JSON.stringify({
        model: 'llama-3.2-90b-vision-instruct',
        messages: [{ role: 'user', content }],
        max_tokens: 2048
      })
    });
    
    if (!response.ok) throw new Error(`Error ${response.status}`);
    const data = await response.json();
    
    return { ai: 'Perplexity', icon: 'üîç', content: data.choices[0].message.content, success: true };
  } catch (error) {
    return { ai: 'Perplexity', icon: 'üîç', content: error.message, success: false };
  }
}

// ============================================
// FUNCIONES DE TEST CONNECTION
// ============================================
// A√±adir estos casos al switch en testConnection():

// En la funci√≥n testConnection(), a√±adir despu√©s del caso 'grok':
else if (aiName === 'deepseek') {
  response = await fetch('https://api.deepseek.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${key}`
    },
    body: JSON.stringify({
      model: 'deepseek-vl',
      messages: [{ role: 'user', content: 'test' }],
      max_tokens: 10
    })
  });
} else if (aiName === 'openai') {
  response = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${key}`
    },
    body: JSON.stringify({
      model: 'gpt-4o',
      messages: [{ role: 'user', content: 'test' }],
      max_tokens: 10
    })
  });
} else if (aiName === 'mistral') {
  response = await fetch('https://api.mistral.ai/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${key}`
    },
    body: JSON.stringify({
      model: 'pixtral-12b-2409',
      messages: [{ role: 'user', content: 'test' }],
      max_tokens: 10
    })
  });
} else if (aiName === 'perplexity') {
  response = await fetch('https://api.perplexity.ai/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${key}`
    },
    body: JSON.stringify({
      model: 'llama-3.2-90b-vision-instruct',
      messages: [{ role: 'user', content: 'test' }],
      max_tokens: 10
    })
  });
}

// ============================================
// ACTUALIZAR loadKeysStatus()
// ============================================
// A√±adir al array en loadKeysStatus():
['claude', 'gemini', 'grok', 'deepseek', 'openai', 'mistral', 'perplexity'].forEach(aiKey => {
  const key = localStorage.getItem(`${aiKey}_api_key`);
  const input = document.getElementById(`${aiKey}-key`);
  
  if (key && input) {
    input.value = key;
    updateStatus(aiKey, 'connected', 'Configurado');
  }
});

// ============================================
// ACTUALIZAR captureAndAnalyze()
// ============================================
// Despu√©s de las variables useGrok y useLocal, a√±adir:
const useDeepSeek = document.getElementById('use-deepseek').checked;
const useOpenAI = document.getElementById('use-openai').checked;
const useMistral = document.getElementById('use-mistral').checked;
const usePerplexity = document.getElementById('use-perplexity').checked;

// En la validaci√≥n de selecci√≥n, cambiar:
if (!useClaude && !useGemini && !useGrok && !useLocal && !useDeepSeek && !useOpenAI && !useMistral && !usePerplexity && customChecked.length === 0) {
  alert('‚ö†Ô∏è Debes seleccionar al menos una IA');
  return;
}

// En la validaci√≥n de API keys:
if (useDeepSeek && !localStorage.getItem('deepseek_api_key')) missingKeys.push('DeepSeek');
if (useOpenAI && !localStorage.getItem('openai_api_key')) missingKeys.push('GPT-4 Vision');
if (useMistral && !localStorage.getItem('mistral_api_key')) missingKeys.push('Pixtral');
if (usePerplexity && !localStorage.getItem('perplexity_api_key')) missingKeys.push('Perplexity');

// Antes de Promise.all:
if (useDeepSeek) promises.push(analyzeWithDeepSeek(imageData));
if (useOpenAI) promises.push(analyzeWithOpenAI(imageData));
if (useMistral) promises.push(analyzeWithMistral(imageData));
if (usePerplexity) promises.push(analyzeWithPerplexity(imageData));

// ============================================
// ACTUALIZAR sendChatMessage()
// ============================================
// Similar a captureAndAnalyze, a√±adir despu√©s de useLocal:
const useDeepSeek = document.getElementById('chat-deepseek').checked;
const useOpenAI = document.getElementById('chat-openai').checked;
const useMistral = document.getElementById('chat-mistral').checked;
const usePerplexity = document.getElementById('chat-perplexity').checked;

// Y antes de Promise.all:
if (useDeepSeek) promises.push(chatWithDeepSeek(message, imageToSend));
if (useOpenAI) promises.push(chatWithOpenAI(message, imageToSend));
if (useMistral) promises.push(chatWithMistral(message, imageToSend));
if (usePerplexity) promises.push(chatWithPerplexity(message, imageToSend));